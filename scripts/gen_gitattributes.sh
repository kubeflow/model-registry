#!/usr/bin/env bash

# This script adds generated files to the .gitattributes file.
# 
# Run from the root of the repo: ./scripts/gen_gitattributes.sh
#
# To verify that the file is up to date, run: ./scripts/gen_gitattributes.sh --check

set -e

MARKER="# Do not edit below this line. Edits will be overwritten by gen_gitattributes.sh";

(
    <.gitattributes sed "/^$MARKER/q" | head -n -1 
    echo $MARKER 
    echo 
    git grep -l 'Code generated by .* DO NOT EDIT\|Generated by OpenAPI Generator' | grep -v 'gen_gitattributes.sh$' | sed 's/$/ linguist-generated=true/'
) >.gitattributes_tmp

if [[ "$1" == "--check" ]]; then
    diff -us .gitattributes .gitattributes_tmp
    RESULT=$?
    rm .gitattributes_tmp
    exit $RESULT
fi

mv .gitattributes_tmp .gitattributes
