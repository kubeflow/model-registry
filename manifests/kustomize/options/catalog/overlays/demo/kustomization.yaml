apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- ../../base

configMapGenerator:
- behavior: replace
  files:
  - sources.yaml=dev-sources.yaml
  - dev-organization-models.yaml=dev-organization-models.yaml
  - dev-validated-models.yaml=dev-validated-models.yaml
  - dev-community-models.yaml=dev-community-models.yaml
  name: model-catalog-sources
  options:
    disableNameSuffixHash: true
- behavior: create
  files:
  - dev-validated-perf-data.tar.gz
  name: model-catalog-demo-perf-data
  options:
    disableNameSuffixHash: true
- behavior: create
  files:
  - mcp-sources.yaml=dev-mcp-catalog-sources.yaml
  - dev-organization-mcp-servers.yaml=dev-organization-mcp-servers.yaml
  - dev-community-mcp-servers.yaml=dev-community-mcp-servers.yaml
  name: mcp-catalog-sources
  options:
    disableNameSuffixHash: true

patches:
- target:
    group: apps
    version: v1
    kind: Deployment
    name: model-catalog-server
  patch: |-
    - op: add
      path: /spec/template/spec/volumes/0
      value:
        name: demo-perf-data
        configMap:
          name: model-catalog-demo-perf-data
    - op: add
      path: /spec/template/spec/volumes/1
      value:
        name: perf-data
        emptyDir: {}
    - op: add
      path: /spec/template/spec/volumes/2
      value:
        name: mcp-catalog-sources
        configMap:
          name: mcp-catalog-sources
    - op: add
      path: /spec/template/spec/containers/0/volumeMounts/0
      value:
        name: perf-data
        mountPath: /perf-data
    - op: add
      path: /spec/template/spec/containers/0/volumeMounts/1
      value:
        name: mcp-catalog-sources
        mountPath: /mcp-catalog
    - op: add
      path: /spec/template/spec/containers/0/args/0
      value: "--performance-metrics=/perf-data"
    - op: add
      path: /spec/template/spec/containers/0/args/1
      value: "--mcp-catalogs-path=/mcp-catalog/mcp-sources.yaml"
    - op: add
      path: /spec/template/spec/initContainers
      value:
        - name: perf-data-init
          image: busybox
          command:
            - /bin/sh
            - -c
            - tar zxf /demo-perf-data/dev-validated-perf-data.tar.gz -C /shared
          volumeMounts:
            - name: perf-data
              mountPath: /shared
            - name: demo-perf-data
              mountPath: /demo-perf-data
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: false
            runAsUser: 0
            capabilities:
              drop:
                - ALL
